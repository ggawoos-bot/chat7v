<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF ë·°ì–´</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: #f5f5f5;
    }
    
    #pdf-viewer-container {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    .title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .search-container {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      max-width: 400px;
    }
    
    .search-input {
      flex: 1;
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      min-width: 0;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #4285f4;
    }
    
    .search-button {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: #4285f4;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .search-button:hover:not(:disabled) {
      background: #357ae8;
    }
    
    .search-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .search-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .search-nav button {
      padding: 4px 8px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      min-width: 32px;
    }
    
    .search-nav button:hover:not(:disabled) {
      background: #f0f0f0;
    }
    
    .search-nav button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .controls button {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .controls button:hover:not(:disabled) {
      background: #f0f0f0;
    }
    
    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .page-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 8px;
    }
    
    .page-input {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }
    
    .viewer-wrapper {
      flex: 1;
      overflow: auto;
      background: #525252;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .loading {
      color: white;
      font-size: 16px;
    }
    
    .error {
      color: #ff4444;
      text-align: center;
      padding: 20px;
    }
    
    .error-message {
      margin-top: 12px;
      font-size: 14px;
    }
    
    canvas {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      max-width: 100%;
      height: auto;
    }
    
    /* í…ìŠ¤íŠ¸ ë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
    .textLayer {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      opacity: 1;
      line-height: 1.0;
    }
    
    .textLayer span {
      color: transparent;
      position: absolute;
      white-space: pre;
      cursor: text;
      transform-origin: 0% 0%;
    }
    
    .textLayer .highlight {
      background-color: rgba(255, 255, 0, 0.4); /* âœ… ë” ì§„í•˜ê²Œ (0.15 â†’ 0.4) */
      border: 1px solid rgba(255, 200, 0, 0.6); /* âœ… ë” ì§„í•˜ê²Œ (0.3 â†’ 0.6) */
      border-radius: 2px;
      padding: 1px 2px;
    }
    
    .textLayer .highlight-strong {
      background-color: rgba(255, 200, 0, 0.5); /* âœ… ë” ì§„í•˜ê²Œ (0.25 â†’ 0.5) */
      border: 2px solid rgba(255, 150, 0, 0.8); /* âœ… ë” ì§„í•˜ê²Œ (0.4 â†’ 0.8, 1px â†’ 2px) */
      border-radius: 3px;
      padding: 2px 3px;
      font-weight: normal; /* âœ… bold ì œê±°í•˜ì—¬ ê¸€ì”¨ ê°€ë…ì„± í–¥ìƒ */
    }
  </style>
</head>
<body>
  <div id="pdf-viewer-container">
    <div class="header">
      <div class="header-top">
        <div class="title" id="pdf-title">PDF ë¡œë”© ì¤‘...</div>
        <div class="controls">
          <button id="prev-btn" disabled>â† ì´ì „</button>
          <div class="page-info">
            <span>í˜ì´ì§€</span>
            <input type="number" id="page-input" min="1" value="1" disabled>
            <span id="total-pages">/ ?</span>
          </div>
          <button id="next-btn" disabled>ë‹¤ìŒ â†’</button>
          <button id="close-btn">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="search-container">
        <input 
          type="text" 
          id="search-input" 
          class="search-input" 
          placeholder="í˜„ì¬ ë¬¸ì„œì—ì„œ ê²€ìƒ‰..."
          autocomplete="off"
        />
        <button id="search-button" class="search-button" disabled>ê²€ìƒ‰</button>
        <div class="search-nav" id="search-nav" style="display: none;">
          <button id="search-prev-btn" disabled>â€¹</button>
          <span id="search-counter" style="font-size: 12px; color: #666; padding: 0 8px;">0/0</span>
          <button id="search-next-btn" disabled>â€º</button>
        </div>
      </div>
    </div>
    <div class="viewer-wrapper" id="viewer-wrapper">
      <div class="loading">PDF ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // PDF.js Worker ì„¤ì •
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const pdfUrlParam = urlParams.get('url') || '';
    const pdfUrl = pdfUrlParam ? decodeURIComponent(pdfUrlParam) : '';
    const initialPage = parseInt(urlParams.get('page') || '1', 10);
    const titleParam = urlParams.get('title') || '';
    const title = titleParam ? decodeURIComponent(titleParam) : 'PDF ë¬¸ì„œ';
    
    // í•˜ì´ë¼ì´íŠ¸ í‚¤ì›Œë“œ ê°€ì ¸ì˜¤ê¸° (ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•˜ê²Œ)
    const highlightParam = urlParams.get('highlight') || '';
    let searchTextParam = urlParams.get('searchText') || '';
    let highlightKeywords = highlightParam 
      ? highlightParam.split(',').filter(k => k.trim().length > 0).map(k => decodeURIComponent(k.trim()))
      : [];
    
    console.log('ğŸ“„ PDF ë·°ì–´ ì´ˆê¸°í™”:', {
      pdfUrl: pdfUrl,
      initialPage: initialPage,
      title: title,
      highlightKeywords: highlightKeywords,
      searchText: searchTextParam.substring(0, 50),
      fullUrl: window.location.href
    });
    
    if (!pdfUrl) {
      const errorHtml = '<div class="error"><div>âŒ PDF URLì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div><div class="error-message">URL íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div></div>';
      document.getElementById('viewer-wrapper').innerHTML = errorHtml;
      console.error('âŒ PDF URLì´ ì—†ìŠµë‹ˆë‹¤. URL íŒŒë¼ë¯¸í„°:', window.location.search);
      throw new Error('PDF URLì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // ì œëª© ì„¤ì •
    document.getElementById('pdf-title').textContent = title;
    
    let pdfDoc = null;
    let currentPage = initialPage;
    let numPages = 0;
    let pageRendering = false;
    let pageNumPending = null;
    // âœ… PDF ë¡œë“œ ì „ ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ëŠ” í
    const queuedMessages = [];
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const viewerWrapper = document.getElementById('viewer-wrapper');
    viewerWrapper.innerHTML = '';
    
    // ìº”ë²„ìŠ¤ì™€ í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼ ë‹´ì„ ì»¨í…Œì´ë„ˆ ìƒì„±
    const pageContainer = document.createElement('div');
    pageContainer.style.position = 'relative';
    pageContainer.style.display = 'inline-block';
    viewerWrapper.appendChild(pageContainer);
    pageContainer.appendChild(canvas);
    
    // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì»¨í…Œì´ë„ˆ ìƒì„±
    const textLayerDiv = document.createElement('div');
    textLayerDiv.className = 'textLayer';
    pageContainer.appendChild(textLayerDiv);
    
    // ìš”ì†Œ ì°¸ì¡°
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInput = document.getElementById('page-input');
    const totalPagesSpan = document.getElementById('total-pages');
    const closeBtn = document.getElementById('close-btn');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const searchNav = document.getElementById('search-nav');
    const searchPrevBtn = document.getElementById('search-prev-btn');
    const searchNextBtn = document.getElementById('search-next-btn');
    const searchCounter = document.getElementById('search-counter');
    
    // ê²€ìƒ‰ ê´€ë ¨ ë³€ìˆ˜
    let searchResults = []; // { page: number, index: number } í˜•íƒœì˜ ê²€ìƒ‰ ê²°ê³¼ ë°°ì—´
    let currentSearchIndex = -1;
    let currentSearchText = '';
    
    // PDF ë¡œë“œ
    console.log('ğŸ“¥ PDF ë¡œë”© ì‹œì‘:', pdfUrl);
    pdfjsLib.getDocument({
      url: pdfUrl,
      httpHeaders: {},
      withCredentials: false
    }).promise.then((pdf) => {
      pdfDoc = pdf;
      numPages = pdf.numPages;
      
      totalPagesSpan.textContent = `/ ${numPages}`;
      pageInput.max = numPages;
      pageInput.disabled = false;
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      searchButton.disabled = false;
      
      // âœ… URLì—ì„œ ê²€ìƒ‰ í…ìŠ¤íŠ¸ê°€ ìˆì–´ë„ ê²€ìƒ‰ì°½ì— ìë™ ì…ë ¥í•˜ì§€ ì•ŠìŒ
      // (í•˜ì´ë¼ì´íŠ¸ëŠ” searchTextParamì„ ì‚¬ìš©í•˜ë¯€ë¡œ ìœ ì§€)
      // if (searchTextParam) {
      //   searchInput.value = searchTextParam;
      //   performSearch(searchTextParam);
      // }
      
      // âœ… íì— ìŒ“ì¸ ë©”ì‹œì§€ ì²˜ë¦¬ (PDF ë¡œë“œ ì „ì— ë°›ì€ ë©”ì‹œì§€ë“¤)
      if (queuedMessages.length > 0) {
        console.log(`ğŸ“¥ íì— ìŒ“ì¸ ${queuedMessages.length}ê°œ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œì‘`);
        queuedMessages.forEach((msg) => {
          processChangePageMessage(msg);
        });
        queuedMessages.length = 0; // í ë¹„ìš°ê¸°
      }
      
      // ì´ˆê¸° í˜ì´ì§€ ë Œë”ë§ (í ì²˜ë¦¬ í›„, ë§ˆì§€ë§‰ ë©”ì‹œì§€ì˜ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒìœ¼ë¡œ, ì—†ìœ¼ë©´ initialPageë¡œ)
      renderPage(currentPage);
      
      console.log('âœ… PDF ë¡œë“œ ì™„ë£Œ:', numPages, 'í˜ì´ì§€');
    }).catch((error) => {
      console.error('âŒ PDF ë¡œë“œ ì˜¤ë¥˜:', error);
      console.error('âŒ PDF URL:', pdfUrl);
      console.error('âŒ ì „ì²´ ì—ëŸ¬ ê°ì²´:', error);
      
      let errorMessage = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      if (error.name === 'MissingPDFException') {
        errorMessage = 'PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.';
      } else if (error.name === 'InvalidPDFException') {
        errorMessage = 'ìœ íš¨í•˜ì§€ ì•Šì€ PDF íŒŒì¼ì…ë‹ˆë‹¤.';
      } else if (error.message && error.message.includes('Network')) {
        errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
      } else if (error.message && error.message.includes('CORS')) {
        errorMessage = 'CORS ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
      }
      
      viewerWrapper.innerHTML = `
        <div class="error">
          <div>âŒ PDF ë¡œë“œ ì‹¤íŒ¨</div>
          <div class="error-message">${errorMessage}</div>
          <div class="error-message" style="margin-top: 8px; font-size: 12px; color: #999;">URL: ${pdfUrl}</div>
          <div class="error-message" style="margin-top: 4px; font-size: 11px; color: #aaa;">ì—ëŸ¬ íƒ€ì…: ${error.name || 'Unknown'}</div>
        </div>
      `;
    });
    
    // í˜ì´ì§€ ë Œë”ë§ (í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë° í•˜ì´ë¼ì´íŠ¸ í¬í•¨)
    function renderPage(num) {
      console.log(`ğŸ”„ renderPage í˜¸ì¶œ: ${num} (í˜„ì¬: ${currentPage}, ë Œë”ë§ ì¤‘: ${pageRendering})`);
      pageRendering = true;
      
      // âœ… í˜ì´ì§€ ì…ë ¥ í•„ë“œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      pageInput.value = num;
      updateButtons();
      
      pdfDoc.getPage(num).then((page) => {
        console.log(`ğŸ“„ PDF í˜ì´ì§€ ${num} ë¡œë“œ ì™„ë£Œ, ë Œë”ë§ ì‹œì‘`);
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        const renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        
        const renderTask = page.render(renderContext);
        
        renderTask.promise.then(() => {
          console.log(`âœ… PDF í˜ì´ì§€ ${num} ìº”ë²„ìŠ¤ ë Œë”ë§ ì™„ë£Œ`);
          // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§ ë° í•˜ì´ë¼ì´íŠ¸
          return page.getTextContent();
        }).then((textContent) => {
          // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì´ˆê¸°í™”
          textLayerDiv.innerHTML = '';
          textLayerDiv.style.width = viewport.width + 'px';
          textLayerDiv.style.height = viewport.height + 'px';
          
          // PDF.jsì˜ í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§
          // PDF.js 3.x ë²„ì „ì—ì„œëŠ” renderTextLayer ì‚¬ìš©
          try {
            pdfjsLib.renderTextLayer({
              textContentSource: textContent,
              container: textLayerDiv,
              viewport: viewport,
              textDivs: []
            });
          } catch (error) {
            console.warn('í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', error);
            // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì‹¤íŒ¨í•´ë„ PDFëŠ” ê³„ì† í‘œì‹œ
          }
          
          // í•˜ì´ë¼ì´íŠ¸ ì ìš© ë° ìŠ¤í¬ë¡¤ (í…ìŠ¤íŠ¸ ë ˆì´ì–´ê°€ ë Œë”ë§ëœ í›„)
          setTimeout(() => {
            // âœ… ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ì–´ë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ URL íŒŒë¼ë¯¸í„° ì‚¬ìš©
            const highlightText = currentSearchText || searchTextParam;
            
            // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ì–´ë¡œ í•˜ì´ë¼ì´íŠ¸ (í‚¤ì›Œë“œ ë¬´ì‹œ)
            if (currentSearchText) {
              applyHighlight(textLayerDiv, [], currentSearchText);
            } else {
              applyHighlight(textLayerDiv, highlightKeywords, highlightText);
            }
            
            // í•˜ì´ë¼ì´íŠ¸ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤ (ì¦‰ì‹œ)
            scrollToHighlight(textLayerDiv);
            console.log(`âœ… í˜ì´ì§€ ${num} ë Œë”ë§ ë° í•˜ì´ë¼ì´íŠ¸ ì™„ë£Œ`);
          }, 300); // 500msì—ì„œ 300msë¡œ ë‹¨ì¶•í•˜ì—¬ ë” ë¹ ë¥¸ ë°˜ì‘
          
          // í˜ì´ì§€ ì „í™˜ í›„ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™” (í•˜ì´ë¼ì´íŠ¸ ìŠ¤í¬ë¡¤ ì „ì— ìƒë‹¨ìœ¼ë¡œ)
          // ì£¼ì˜: scrollToHighlightì—ì„œ ë‹¤ì‹œ ìŠ¤í¬ë¡¤í•˜ë¯€ë¡œ ì´ ë¶€ë¶„ì€ ì œê±°í•˜ê±°ë‚˜ ìˆœì„œ ì¡°ì • í•„ìš”
          // scrollToHighlightê°€ í•˜ì´ë¼ì´íŠ¸ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°ì—ë§Œ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
          
          pageRendering = false;
          console.log(`âœ… í˜ì´ì§€ ${num} ë Œë”ë§ ì™„ì „íˆ ì™„ë£Œ`);
          if (pageNumPending !== null) {
            const pending = pageNumPending;
            pageNumPending = null;
            console.log(`ğŸ“„ ëŒ€ê¸° ì¤‘ì¸ í˜ì´ì§€ ${pending} ë Œë”ë§ ì‹œì‘`);
            renderPage(pending);
          }
        }).catch((error) => {
          console.error('í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§ ì˜¤ë¥˜:', error);
          pageRendering = false;
          if (pageNumPending !== null) {
            const pending = pageNumPending;
            pageNumPending = null;
            console.log(`ğŸ“„ ì˜¤ë¥˜ í›„ ëŒ€ê¸° ì¤‘ì¸ í˜ì´ì§€ ${pending} ë Œë”ë§ ì‹œì‘`);
            renderPage(pending);
          }
        });
      }).catch((error) => {
        console.error(`âŒ PDF í˜ì´ì§€ ${num} ë¡œë“œ ì‹¤íŒ¨:`, error);
        pageRendering = false;
        if (pageNumPending !== null) {
          const pending = pageNumPending;
          pageNumPending = null;
          renderPage(pending);
        }
      });
    }
    
    // âœ… í…ìŠ¤íŠ¸ ì •ê·œí™” í•¨ìˆ˜ (ë§¤ì¹­ìš©) - ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ì •ê·œí™”ë¡œ ë§¤ì¹­ ì •í™•ë„ í–¥ìƒ
    function normalizeTextForMatching(text) {
      if (!text) return '';
      return text
        .replace(/\s+/g, ' ')           // ì—°ì† ê³µë°±ì„ í•˜ë‚˜ë¡œ
        .replace(/[\n\r\t]/g, ' ')      // ì¤„ë°”ê¿ˆ/íƒ­ì„ ê³µë°±ìœ¼ë¡œ
        .replace(/[^\wê°€-í£\s:;]/g, '') // íŠ¹ìˆ˜ë¬¸ì ì œê±° (í•œê¸€, ì˜ë¬¸, ìˆ«ì, ì½œë¡ , ì„¸ë¯¸ì½œë¡ ë§Œ ìœ ì§€)
        .toLowerCase()
        .trim();
    }
    
    // í•˜ì´ë¼ì´íŠ¸ ì ìš© í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „: ì •í™•í•œ í…ìŠ¤íŠ¸ ë§¤ì¹­ + í…ìŠ¤íŠ¸ ì •ê·œí™”)
    function applyHighlight(textLayer, keywords, searchText) {
      if (!textLayer || (!keywords.length && !searchText)) {
        console.log('âš ï¸ í•˜ì´ë¼ì´íŠ¸í•  í‚¤ì›Œë“œë‚˜ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // âœ… ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸ ì œê±°
      textLayer.querySelectorAll('.highlight, .highlight-strong').forEach(el => {
        el.classList.remove('highlight', 'highlight-strong');
      });
      
      const textSpans = textLayer.querySelectorAll('span');
      let highlightCount = 0;
      
      // âœ… 1ë‹¨ê³„: ê²€ìƒ‰ í…ìŠ¤íŠ¸ë¡œ ì •í™•í•œ ë§¤ì¹­ (ì½¤ë§ˆ êµ¬ë¶„ ê²€ìƒ‰ì–´ ì§€ì›)
      if (searchText && searchText.trim().length > 0) {
        // âœ… ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ê²€ìƒ‰ì–´ íŒŒì‹±
        const searchQueries = searchText
          .split(',')
          .map(q => q.trim())
          .filter(q => q.length >= 3) // ìµœì†Œ 3ì ì´ìƒ
          .map(q => normalizeTextForMatching(q)); // âœ… í…ìŠ¤íŠ¸ ì •ê·œí™” ì ìš©
        
        if (searchQueries.length > 0) {
          const isMultiSearch = searchQueries.length > 1;
          
          if (isMultiSearch) {
            // âœ… ë³µìˆ˜ ê²€ìƒ‰ì–´: ê° ê²€ìƒ‰ì–´ë¥¼ ëª¨ë‘ í•˜ì´ë¼ì´íŠ¸ (ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ë¡œ ë§¤ì¹­)
            textSpans.forEach((span) => {
              const text = normalizeTextForMatching(span.textContent || '');
              if (!text.trim()) return;
              
              // ëª¨ë“  ê²€ìƒ‰ì–´ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ í•˜ì´ë¼ì´íŠ¸
              for (const query of searchQueries) {
                if (text.includes(query)) {
                  span.classList.add('highlight-strong');
                  highlightCount++;
                  break; // í•˜ë‚˜ë§Œ ì°¾ìœ¼ë©´ ì¶©ë¶„ (ì¤‘ë³µ ë°©ì§€)
                }
              }
            });
            
            if (highlightCount > 0) {
              console.log(`âœ… ë³µìˆ˜ ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸ ì ìš© ì™„ë£Œ: ${highlightCount}ê°œ ìš”ì†Œ (${searchQueries.length}ê°œ ê²€ìƒ‰ì–´)`);
              return; // ê²€ìƒ‰ í…ìŠ¤íŠ¸ë¡œ í•˜ì´ë¼ì´íŠ¸í–ˆìœ¼ë©´ í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŠ¸ëŠ” ìŠ¤í‚µ
            }
          } else {
            // ë‹¨ì¼ ê²€ìƒ‰ì–´: ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ë¡œ ë§¤ì¹­ + ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­
            const trimmedSearchText = searchText.trim();
            
            // âœ… ê°œì„ : ê²€ìƒ‰ì–´ë¥¼ ë‹¨ì–´ë¡œ ë¶„ë¦¬ (ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ìš©)
            const searchWords = normalizeTextForMatching(trimmedSearchText)
              .split(/\s+/)
              .filter(w => w.trim().length >= 2) // ìµœì†Œ 2ì ì´ìƒ
              .filter(w => {
                // ë¶ˆí•„ìš”í•œ ë‹¨ì–´ ì œê±° (ì¡°ì‚¬, ì ‘ì†ì‚¬ ë“±)
                const stopWords = ['ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì˜', 'ì™€', 'ê³¼', 'ë„', 'ë§Œ', 'ë¡œ', 'ìœ¼ë¡œ', 'ë°', 'ë“±'];
                return !stopWords.includes(w.trim());
              });
            
            console.log(`ğŸ” ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­: ${searchWords.length}ê°œ ë‹¨ì–´`, searchWords.slice(0, 10));
            
            // ê²€ìƒ‰ì–´ê°€ ê¸´ ê²½ìš°(20ì ì´ìƒ) í•µì‹¬ ë¶€ë¶„ë§Œ ì‚¬ìš©, ì§§ì€ ê²½ìš° ì „ì²´ ì‚¬ìš©
            const coreText = trimmedSearchText.length >= 20 
              ? trimmedSearchText.substring(0, 25).trim()
              : trimmedSearchText;
            
            // âœ… ê²€ìƒ‰ì–´ ì •ê·œí™”
            const normalizedCoreText = normalizeTextForMatching(coreText);
            
            if (normalizedCoreText.length >= 3) {
              // ì—°ì†ëœ spanë“¤ì„ í•©ì³ì„œ í…ìŠ¤íŠ¸ ìƒì„± (ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ë¡œ)
              let accumulatedText = '';
              let accumulatedSpans = [];
              let foundMatch = false;
              
              textSpans.forEach((span) => {
                const text = span.textContent || '';
                if (text.trim()) {
                  accumulatedText += text;
                  accumulatedSpans.push(span);
                  
                  // âœ… ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ë¡œ ë§¤ì¹­ (ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ì°¨ì´ ë¬´ì‹œ)
                  const normalizedAccumulated = normalizeTextForMatching(accumulatedText);
                  if (normalizedAccumulated.includes(normalizedCoreText)) {
                    foundMatch = true;
                    // ê²€ìƒ‰ì–´ ê¸¸ì´ì˜ 2ë°° ì´ë‚´ì¼ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸ (ê³¼ë„í•œ í•˜ì´ë¼ì´íŠ¸ ë°©ì§€)
                    const maxLength = coreText.length * 2.5;
                    if (accumulatedText.length <= maxLength) {
                      accumulatedSpans.forEach(s => {
                        s.classList.add('highlight-strong');
                        highlightCount++;
                      });
                    } else {
                      // ë„ˆë¬´ ê¸¸ë©´ ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ ë¶€ë¶„ë§Œ í•˜ì´ë¼ì´íŠ¸ (ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ë¡œ)
                      accumulatedSpans.forEach(s => {
                        const spanText = normalizeTextForMatching(s.textContent || '');
                        if (spanText.includes(normalizedCoreText)) {
                          s.classList.add('highlight-strong');
                          highlightCount++;
                        }
                      });
                    }
                    accumulatedText = '';
                    accumulatedSpans = [];
                  }
                  
                  // í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ë¦¬ì…‹ (ê²€ìƒ‰ì–´ì˜ 3ë°° ì´ìƒ)
                  if (accumulatedText.length > coreText.length * 3) {
                    accumulatedText = '';
                    accumulatedSpans = [];
                  }
                }
              });
              
              // âœ… ê°œì„ : ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ (ì „ì²´ ë¬¸ì¥ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ)
              if (!foundMatch || highlightCount === 0) {
                // 1. ì „ì²´ ë¬¸ì¥ ë§¤ì¹­ ì‹œë„ (ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ë¡œ)
                textSpans.forEach((span) => {
                  const text = normalizeTextForMatching(span.textContent || '');
                  if (text.includes(normalizedCoreText)) {
                    span.classList.add('highlight-strong');
                    highlightCount++;
                  }
                });
                
                // 2. ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ (ì—¬ëŸ¬ ë‹¨ì–´ê°€ ë§¤ì¹­ë˜ë©´ í•˜ì´ë¼ì´íŠ¸)
                if (highlightCount === 0 && searchWords.length > 0) {
                  let wordMatchCount = 0;
                  const matchedWordSet = new Set();
                  
                  // ì—°ì†ëœ spanë“¤ì„ í•©ì³ì„œ ë‹¨ì–´ ë§¤ì¹­
                  let accumulatedText = '';
                  let accumulatedSpans = [];
                  
                  textSpans.forEach((span) => {
                    const text = span.textContent || '';
                    if (text.trim()) {
                      accumulatedText += text;
                      accumulatedSpans.push(span);
                      
                      const normalizedAccumulated = normalizeTextForMatching(accumulatedText);
                      let matchedWords = 0;
                      
                      for (const searchWord of searchWords) {
                        if (normalizedAccumulated.includes(searchWord)) {
                          matchedWords++;
                          matchedWordSet.add(searchWord);
                        }
                      }
                      
                      // ë‹¨ì–´ ë§¤ì¹­ ë¹„ìœ¨ì´ 30% ì´ìƒì´ë©´ í•˜ì´ë¼ì´íŠ¸
                      const wordRatio = matchedWords / searchWords.length;
                      if (wordRatio >= 0.3 && matchedWords >= 2) {
                        accumulatedSpans.forEach(s => {
                          s.classList.add('highlight-strong');
                          highlightCount++;
                        });
                        wordMatchCount = Math.max(wordMatchCount, matchedWords);
                        accumulatedText = '';
                        accumulatedSpans = [];
                      }
                      
                      // í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ë¦¬ì…‹
                      if (accumulatedText.length > 200) {
                        accumulatedText = '';
                        accumulatedSpans = [];
                      }
                    }
                  });
                  
                  // ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ, ê° spanì—ì„œ ê°œë³„ ë‹¨ì–´ ë§¤ì¹­
                  if (highlightCount === 0) {
                    textSpans.forEach((span) => {
                      const text = normalizeTextForMatching(span.textContent || '');
                      let matchedWords = 0;
                      
                      for (const searchWord of searchWords) {
                        if (text.includes(searchWord)) {
                          matchedWords++;
                        }
                      }
                      
                      // ìµœì†Œ 2ê°œ ì´ìƒ ë‹¨ì–´ê°€ ë§¤ì¹­ë˜ë©´ í•˜ì´ë¼ì´íŠ¸
                      if (matchedWords >= 2) {
                        span.classList.add('highlight-strong');
                        highlightCount++;
                      }
                    });
                  }
                  
                  if (highlightCount > 0) {
                    console.log(`âœ… ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ í•˜ì´ë¼ì´íŠ¸: ${highlightCount}ê°œ ìš”ì†Œ, ${wordMatchCount || matchedWordSet.size}/${searchWords.length}ê°œ ë‹¨ì–´ ë§¤ì¹­`);
                  }
                }
              }
              
              if (highlightCount > 0) {
                console.log(`âœ… ê²€ìƒ‰ í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ ì ìš© ì™„ë£Œ: ${highlightCount}ê°œ ìš”ì†Œ (ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ ë§¤ì¹­)`);
                return; // ê²€ìƒ‰ í…ìŠ¤íŠ¸ë¡œ í•˜ì´ë¼ì´íŠ¸í–ˆìœ¼ë©´ í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŠ¸ëŠ” ìŠ¤í‚µ
              }
            }
          }
        }
      }
      
      // âœ… 2ë‹¨ê³„: í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŠ¸ (ì§§ê³  ì •í™•í•œ í‚¤ì›Œë“œë§Œ, ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­)
      if (keywords.length > 0) {
        const shortKeywords = keywords.filter(k => k && k.trim().length >= 3 && k.trim().length <= 20); // 3~20ìë§Œ
        
        textSpans.forEach((span) => {
          const text = span.textContent || '';
          if (!text.trim()) return;
          
          let shouldHighlight = false;
          
          for (const keyword of shortKeywords) {
            const trimmedKeyword = keyword.trim();
            // âœ… ì •í™•í•œ ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ ì‹œë„ (ì˜ì–´/ìˆ«ì í¬í•¨)
            const keywordRegex = new RegExp(`\\b${trimmedKeyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
            
            // ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ ë˜ëŠ” ì§ì ‘ í¬í•¨ í™•ì¸ (í•œê¸€ì˜ ê²½ìš° ë‹¨ì–´ ê²½ê³„ê°€ ëª…í™•í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í¬í•¨ í™•ì¸ë„ ì‚¬ìš©)
            if (keywordRegex.test(text) || (trimmedKeyword.length >= 4 && text.includes(trimmedKeyword))) {
              shouldHighlight = true;
              break;
            }
          }
          
          if (shouldHighlight) {
            span.classList.add('highlight');
            highlightCount++;
          }
        });
      }
      
      console.log(`âœ… í•˜ì´ë¼ì´íŠ¸ ì ìš© ì™„ë£Œ: ${highlightCount}ê°œ ìš”ì†Œ`);
    }
    
    // í•˜ì´ë¼ì´íŠ¸ëœ ìš”ì†Œë¡œ ìŠ¤í¬ë¡¤ (ì¦‰ì‹œ ì‹¤í–‰)
    function scrollToHighlight(textLayer) {
      const highlighted = textLayer.querySelector('.highlight, .highlight-strong');
      if (highlighted) {
        console.log('ğŸ“ í•˜ì´ë¼ì´íŠ¸ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤ ì¤‘...');
        // ì¦‰ì‹œ ìŠ¤í¬ë¡¤ (smooth ëŒ€ì‹  autoë¡œ ë³€ê²½í•˜ì—¬ ë” ë¹ ë¥¸ ë°˜ì‘)
        highlighted.scrollIntoView({ 
          behavior: 'auto', // 'smooth'ì—ì„œ 'auto'ë¡œ ë³€ê²½í•˜ì—¬ ì¦‰ì‹œ ìŠ¤í¬ë¡¤
          block: 'center',
          inline: 'nearest'
        });
        console.log('âœ… í•˜ì´ë¼ì´íŠ¸ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤ ì™„ë£Œ');
      } else {
        // í•˜ì´ë¼ì´íŠ¸ê°€ ì—†ìœ¼ë©´ í˜ì´ì§€ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        viewerWrapper.scrollTop = 0;
        console.log('ğŸ“ í•˜ì´ë¼ì´íŠ¸ ì—†ìŒ, í˜ì´ì§€ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤');
      }
    }
    
    // ê²€ìƒ‰ í•¨ìˆ˜: ì „ì²´ PDFì—ì„œ ê²€ìƒ‰ì–´ ì°¾ê¸° (ì½¤ë§ˆ êµ¬ë¶„ ì§€ì›)
    async function performSearch(searchText) {
      if (!pdfDoc || !searchText || !searchText.trim()) {
        console.log('âš ï¸ ê²€ìƒ‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', { pdfDoc: !!pdfDoc, searchText });
        return;
      }
      
      // âœ… ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ê²€ìƒ‰ì–´ íŒŒì‹±
      const searchQueries = searchText
        .split(',')
        .map(q => q.trim())
        .filter(q => q.length > 0)
        .map(q => q.toLowerCase());
      
      // ë‹¨ì¼ ê²€ìƒ‰ì–´ì¸ì§€ ë³µìˆ˜ ê²€ìƒ‰ì–´ì¸ì§€ í™•ì¸
      const isMultiSearch = searchQueries.length > 1;
      
      console.log(`ğŸ” ê²€ìƒ‰ ì‹œì‘: ${isMultiSearch ? 'ë³µìˆ˜ ê²€ìƒ‰ì–´ (AND ì¡°ê±´)' : 'ë‹¨ì¼ ê²€ìƒ‰ì–´'}`, searchQueries);
      
      currentSearchText = searchText.trim(); // ì›ë³¸ í…ìŠ¤íŠ¸ ìœ ì§€ (í•˜ì´ë¼ì´íŠ¸ìš©)
      searchResults = [];
      currentSearchIndex = -1;
      
      // ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”
      searchButton.disabled = true;
      searchButton.textContent = 'ê²€ìƒ‰ì¤‘...';
      
      try {
        // ëª¨ë“  í˜ì´ì§€ì—ì„œ ê²€ìƒ‰
        for (let pageNum = 1; pageNum <= numPages; pageNum++) {
          try {
            const page = await pdfDoc.getPage(pageNum);
            const textContent = await page.getTextContent();
            
            // í˜ì´ì§€ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°
            let fullText = '';
            textContent.items.forEach(item => {
              if (item.str) {
                fullText += item.str + ' ';
              }
            });
            
            const textLower = fullText.toLowerCase();
            
            if (isMultiSearch) {
              // âœ… ë³µìˆ˜ ê²€ìƒ‰ì–´: ëª¨ë“  ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ í˜ì´ì§€ë§Œ ì°¾ê¸° (AND ì¡°ê±´)
              const allKeywordsFound = searchQueries.every(query => 
                textLower.includes(query)
              );
              
              if (allKeywordsFound) {
                // ëª¨ë“  ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ ê²½ìš°, í˜ì´ì§€ë¥¼ ê²°ê³¼ì— ì¶”ê°€
                searchResults.push({
                  page: pageNum,
                  index: 0, // í˜ì´ì§€ë‹¹ í•˜ë‚˜ì˜ ê²°ê³¼ë§Œ
                  keywords: searchQueries // í•˜ì´ë¼ì´íŠ¸ìš© ê²€ìƒ‰ì–´ ëª©ë¡
                });
              }
            } else {
              // ë‹¨ì¼ ê²€ìƒ‰ì–´: ê¸°ì¡´ ë¡œì§ (ëª¨ë“  ë§¤ì¹­ ìœ„ì¹˜ ì°¾ê¸°)
              const query = searchQueries[0];
              let index = textLower.indexOf(query);
              let resultIndex = 0;
              
              while (index !== -1) {
                searchResults.push({
                  page: pageNum,
                  index: resultIndex
                });
                resultIndex++;
                index = textLower.indexOf(query, index + 1);
              }
            }
          } catch (error) {
            console.warn(`âš ï¸ í˜ì´ì§€ ${pageNum} ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:`, error);
          }
        }
        
        console.log(`âœ… ê²€ìƒ‰ ì™„ë£Œ: ${searchResults.length}ê°œ ${isMultiSearch ? 'í˜ì´ì§€' : 'ê²°ê³¼'} ë°œê²¬`);
        
        // ê²€ìƒ‰ ê²°ê³¼ UI ì—…ë°ì´íŠ¸
        if (searchResults.length > 0) {
          currentSearchIndex = 0;
          searchNav.style.display = 'flex';
          updateSearchNav();
          // ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì´ë™
          navigateToSearchResult(0);
        } else {
          searchNav.style.display = 'none';
          alert(isMultiSearch 
            ? `ëª¨ë“  ê²€ìƒ‰ì–´(${searchQueries.join(', ')})ê°€ í¬í•¨ëœ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
            : 'ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          );
        }
      } catch (error) {
        console.error('âŒ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        searchButton.disabled = false;
        searchButton.textContent = 'ê²€ìƒ‰';
      }
    }
    
    // ê²€ìƒ‰ ê²°ê³¼ë¡œ ì´ë™
    function navigateToSearchResult(index) {
      if (index < 0 || index >= searchResults.length) return;
      
      currentSearchIndex = index;
      const result = searchResults[index];
      
      console.log(`ğŸ“„ ê²€ìƒ‰ ê²°ê³¼ ${index + 1}/${searchResults.length}ë¡œ ì´ë™: í˜ì´ì§€ ${result.page}`);
      
      // í˜ì´ì§€ ë³€ê²½
      if (currentPage !== result.page) {
        currentPage = result.page;
        queueRenderPage(currentPage);
        // í˜ì´ì§€ ë Œë”ë§ ì™„ë£Œ í›„ í•˜ì´ë¼ì´íŠ¸ (renderPage í•¨ìˆ˜ ë‚´ì—ì„œ ì²˜ë¦¬ë¨)
      } else {
        // ê°™ì€ í˜ì´ì§€ë©´ í•˜ì´ë¼ì´íŠ¸ë§Œ ì—…ë°ì´íŠ¸
        const textLayerDiv = document.querySelector('.textLayer');
        if (textLayerDiv) {
          setTimeout(() => {
            applyHighlight(textLayerDiv, [], currentSearchText);
            scrollToHighlight(textLayerDiv);
          }, 300);
        }
      }
      
      updateSearchNav();
    }
    
    // ê²€ìƒ‰ ë„¤ë¹„ê²Œì´ì…˜ UI ì—…ë°ì´íŠ¸
    function updateSearchNav() {
      if (searchResults.length === 0) {
        searchNav.style.display = 'none';
        return;
      }
      
      searchCounter.textContent = `${currentSearchIndex + 1}/${searchResults.length}`;
      searchPrevBtn.disabled = currentSearchIndex <= 0;
      searchNextBtn.disabled = currentSearchIndex >= searchResults.length - 1;
    }
    
    // í˜ì´ì§€ ë³€ê²½ í
    function queueRenderPage(num) {
      console.log(`ğŸ“‹ queueRenderPage í˜¸ì¶œ: ${num}, ë Œë”ë§ ì¤‘: ${pageRendering}`);
      if (pageRendering) {
        console.log(`â¸ï¸ ë Œë”ë§ ì¤‘ì´ë¯€ë¡œ í˜ì´ì§€ ${num} ëŒ€ê¸° íì— ì¶”ê°€`);
        pageNumPending = num;
      } else {
        console.log(`â–¶ï¸ ì¦‰ì‹œ í˜ì´ì§€ ${num} ë Œë”ë§ ì‹œì‘`);
        renderPage(num);
      }
    }
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateButtons() {
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= numPages;
    }
    
    // ì´ì „ í˜ì´ì§€
    prevBtn.addEventListener('click', () => {
      if (currentPage <= 1) return;
      currentPage--;
      queueRenderPage(currentPage);
    });
    
    // ë‹¤ìŒ í˜ì´ì§€
    nextBtn.addEventListener('click', () => {
      if (currentPage >= numPages) return;
      currentPage++;
      queueRenderPage(currentPage);
    });
    
    // í˜ì´ì§€ ì…ë ¥
    pageInput.addEventListener('change', () => {
      const page = parseInt(pageInput.value, 10);
      if (page >= 1 && page <= numPages) {
        currentPage = page;
        queueRenderPage(currentPage);
      } else {
        pageInput.value = currentPage;
      }
    });
    
    // ë‹«ê¸° ë²„íŠ¼
    closeBtn.addEventListener('click', () => {
      window.close();
    });
    
    // ê²€ìƒ‰ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
    searchInput.addEventListener('input', () => {
      // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”
      searchButton.disabled = !searchInput.value.trim();
    });
    
    // âœ… Enter í‚¤ë¡œ ê²€ìƒ‰ ë° ë‹¤ìŒ ê²°ê³¼ ì´ë™
    let lastSearchText = '';
    
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const searchText = searchInput.value.trim();
        
        if (!searchText) return;
        
        // ê°™ì€ ê²€ìƒ‰ì–´ì´ê³  ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ê²°ê³¼ë¡œ ì´ë™
        if (lastSearchText === searchText && 
            searchResults.length > 0 && 
            currentSearchIndex >= 0) {
          // ë‹¤ìŒ ê²€ìƒ‰ ê²°ê³¼ë¡œ ì´ë™
          if (currentSearchIndex < searchResults.length - 1) {
            navigateToSearchResult(currentSearchIndex + 1);
          } else {
            // ë§ˆì§€ë§‰ ê²°ê³¼ë©´ ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ (ìˆœí™˜)
            navigateToSearchResult(0);
          }
        } else {
          // ê²€ìƒ‰ì–´ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ê²€ìƒ‰ ìˆ˜í–‰
          lastSearchText = searchText;
          performSearch(searchText);
        }
      }
    });
    
    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    searchButton.addEventListener('click', () => {
      if (searchInput.value.trim()) {
        performSearch(searchInput.value);
      }
    });
    
    // ê²€ìƒ‰ ì´ì „/ë‹¤ìŒ ë²„íŠ¼
    searchPrevBtn.addEventListener('click', () => {
      if (currentSearchIndex > 0) {
        navigateToSearchResult(currentSearchIndex - 1);
      }
    });
    
    searchNextBtn.addEventListener('click', () => {
      if (currentSearchIndex < searchResults.length - 1) {
        navigateToSearchResult(currentSearchIndex + 1);
      }
    });
    
    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', (e) => {
      // Ctrl+F ë˜ëŠ” Cmd+Fë¡œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ (ê¸°ë³¸ ë™ì‘ ë°©ì§€)
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        searchInput.focus();
        return;
      }
      
      // ê²€ìƒ‰ ê²°ê³¼ ë„¤ë¹„ê²Œì´ì…˜ (ê²€ìƒ‰ ì¤‘ì¼ ë•Œë§Œ)
      if (searchResults.length > 0) {
        if (e.key === 'F3' || ((e.ctrlKey || e.metaKey) && e.key === 'g')) {
          e.preventDefault();
          if (e.shiftKey) {
            // Shift+F3 ë˜ëŠ” Shift+Ctrl+G: ì´ì „ ê²°ê³¼
            if (currentSearchIndex > 0) {
              navigateToSearchResult(currentSearchIndex - 1);
            }
          } else {
            // F3 ë˜ëŠ” Ctrl+G: ë‹¤ìŒ ê²°ê³¼
            if (currentSearchIndex < searchResults.length - 1) {
              navigateToSearchResult(currentSearchIndex + 1);
            }
          }
          return;
        }
      }
      
      // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ì—†ì„ ë•Œë§Œ)
      if (document.activeElement !== searchInput) {
        if (e.key === 'ArrowLeft' && currentPage > 1) {
          currentPage--;
          queueRenderPage(currentPage);
        } else if (e.key === 'ArrowRight' && currentPage < numPages) {
          currentPage++;
          queueRenderPage(currentPage);
        }
      }
    });
    
    // âœ… í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜ (ê³µí†µ ë¡œì§)
    function processChangePageMessage(data) {
      console.log('ğŸ”§ processChangePageMessage ì‹œì‘:', data);
      console.log('ğŸ”§ í˜„ì¬ ìƒíƒœ:', {
        currentPage,
        numPages,
        pageRendering,
        pdfDoc: !!pdfDoc
      });
      
      if (!data || !data.page || data.page <= 0) {
        console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€:', data);
        return;
      }
      
      // í˜ì´ì§€ ë²”ìœ„ í™•ì¸
      if (numPages > 0 && data.page > numPages) {
        console.warn(`âš ï¸ ìš”ì²­ëœ í˜ì´ì§€(${data.page})ê°€ ì´ í˜ì´ì§€ ìˆ˜(${numPages})ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
        return;
      }
      
      // í˜„ì¬ í˜ì´ì§€ì™€ ê°™ì€ ê²½ìš° ìŠ¤í‚µ (ë¶ˆí•„ìš”í•œ ë Œë”ë§ ë°©ì§€)
      if (currentPage === data.page) {
        console.log(`â„¹ï¸ ì´ë¯¸ í˜ì´ì§€ ${data.page}ì— ìˆìŒ, ìŠ¤í‚µ`);
        return;
      }
      
      console.log(`ğŸ“„ í˜ì´ì§€ ì´ë™: ${currentPage} â†’ ${data.page}`);
      
      // í˜ì´ì§€ ì¦‰ì‹œ ë³€ê²½
      currentPage = data.page;
      
      // í•˜ì´ë¼ì´íŠ¸ í‚¤ì›Œë“œ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ë³€ê²½ ì „ì— ì—…ë°ì´íŠ¸)
      if (data.highlight && Array.isArray(data.highlight)) {
        highlightKeywords.length = 0;
        highlightKeywords.push(...data.highlight);
        console.log('ğŸ“„ í•˜ì´ë¼ì´íŠ¸ í‚¤ì›Œë“œ ì—…ë°ì´íŠ¸:', highlightKeywords);
      }
      
      // ê²€ìƒ‰ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      if (data.searchText) {
        searchTextParam = data.searchText;
        console.log('ğŸ“„ ê²€ìƒ‰ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸:', searchTextParam.substring(0, 50) + '...');
      }
      
      // í˜ì´ì§€ ë Œë”ë§ (ì¦‰ì‹œ ì‹¤í–‰)
      console.log(`ğŸš€ queueRenderPage(${currentPage}) í˜¸ì¶œ`);
      queueRenderPage(currentPage);
      
      console.log(`âœ… í˜ì´ì§€ ${data.page}ë¡œ ì´ë™ ìš”ì²­ ì™„ë£Œ`);
    }
    
    // âœ… ë¶€ëª¨ ì°½ì—ì„œ í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€ ìˆ˜ì‹ 
    window.addEventListener('message', (event) => {
      // ë³´ì•ˆ: ê°™ì€ originì—ì„œë§Œ ë©”ì‹œì§€ ìˆ˜ì‹ 
      if (event.origin !== window.location.origin) {
        console.warn('âš ï¸ ë‹¤ë¥¸ originì—ì„œ ì˜¨ ë©”ì‹œì§€ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤:', event.origin);
        return;
      }
      
      const data = event.data;
      if (data && data.type === 'changePage') {
        console.log('ğŸ“¥ í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
        
        // PDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ íì— ì €ì¥
        if (!pdfDoc || numPages === 0) {
          console.log('â³ PDF ë¡œë“œ ì „ ë©”ì‹œì§€ ìˆ˜ì‹ , íì— ì¶”ê°€:', data);
          queuedMessages.push(data);
          return;
        }
        
        // PDFê°€ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì²˜ë¦¬
        processChangePageMessage(data);
      }
    });
    
    // âœ… ë§ˆìš°ìŠ¤ íœ ë¡œ í˜ì´ì§€ ê°„ ì´ë™ (ìŠ¤í¬ë¡¤ì´ ìƒë‹¨/í•˜ë‹¨ì— ë„ë‹¬í•˜ë©´ í˜ì´ì§€ ì´ë™)
    let wheelCooldown = false;
    viewerWrapper.addEventListener('wheel', (e) => {
      // ì¿¨ë‹¤ìš´ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (wheelCooldown) return;
      
      const wrapper = viewerWrapper;
      const scrollTop = wrapper.scrollTop;
      const scrollHeight = wrapper.scrollHeight;
      const clientHeight = wrapper.clientHeight;
      
      // ìŠ¤í¬ë¡¤ì´ ìƒë‹¨ ê·¼ì²˜ì´ê³  ìœ„ë¡œ ìŠ¤í¬ë¡¤ ì‹œ
      if (scrollTop <= 10 && e.deltaY < 0 && currentPage > 1) {
        e.preventDefault();
        wheelCooldown = true;
        currentPage--;
        queueRenderPage(currentPage);
        console.log(`ğŸ“„ íœ ë¡œ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™: ${currentPage}`);
        
        // ì¿¨ë‹¤ìš´ í•´ì œ (500ms í›„)
        setTimeout(() => {
          wheelCooldown = false;
        }, 500);
      }
      // ìŠ¤í¬ë¡¤ì´ í•˜ë‹¨ ê·¼ì²˜ì´ê³  ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ ì‹œ
      else if (scrollTop + clientHeight >= scrollHeight - 10 && e.deltaY > 0 && currentPage < numPages) {
        e.preventDefault();
        wheelCooldown = true;
        currentPage++;
        queueRenderPage(currentPage);
        console.log(`ğŸ“„ íœ ë¡œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™: ${currentPage}`);
        
        // ì¿¨ë‹¤ìš´ í•´ì œ (500ms í›„)
        setTimeout(() => {
          wheelCooldown = false;
        }, 500);
      }
    }, { passive: false }); // passive: falseë¡œ ì„¤ì •í•˜ì—¬ preventDefault ê°€ëŠ¥í•˜ê²Œ í•¨
  </script>
</body>
</html>

